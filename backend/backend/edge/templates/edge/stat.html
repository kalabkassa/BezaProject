{% extends 'edge/navbar.html' %} {% block content %}
<!-- partial:index.partial.html -->
<main class="main">
    <h1 class="main__title">Patient Stat</h1>
    <div class="statcontainer">
        <div id="map" style="width: 400px"></div>
        <div class="gauge-container">
            <div class="gauge"></div>
            <div class="gauge"></div>
        </div>
    </div>
    <div class="patients-list">
        {% for p in patients %}
        <div class="patient-list" onclick="moveToTop(this)" id="{{p.user}}">
            <h2 class="name">{{p.user}}</h2>
            <p class="id">ID: {{p.id}}</p>
        </div>
        {% endfor %}
        <!-- Add more patient entries here -->
    </div>
</main>

<svg
    width="0"
    height="0"
    version="1.1"
    class="gradient-mask"
    xmlns="http://www.w3.org/2000/svg"
>
    <defs>
        <linearGradient id="gradientGauge">
            <stop class="color-red" offset="0%" />
            <stop class="color-yellow" offset="17%" />
            <stop class="color-green" offset="40%" />
            <stop class="color-yellow" offset="87%" />
            <stop class="color-red" offset="100%" />
        </linearGradient>
    </defs>
</svg>
<!-- partial -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.0.2/jquery.min.js"></script>
<script src="https://cdn3.devexpress.com/jslib/17.1.6/js/dx.all.js"></script>
<script>
    function moveToTop(element) {
        var parent = element.parentNode;
        parent.insertBefore(element, parent.firstChild);
        user = element.id;
        // Add a marker to the map
    }
    var user;
    var map = L.map("map").setView([0.0, 0.0], 13);

    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        attribution:
            '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
    }).addTo(map);

    // Add a marker to the map
    L.marker([51.5, -0.09])
        .addTo(map)
        .bindPopup("A sample marker!")
        .openPopup();

    const socket2 = new WebSocket("ws://" + window.location.host + "/update/");
    $(function () {
        class GaugeChart {
            constructor(element, params) {
                this._element = element;
                this._initialValue = params.initialValue;
                this._higherValue = params.higherValue;
                this._title = params.title;
                this._subtitle = params.subtitle;
            }

            _buildConfig() {
                let element = this._element;

                return {
                    value: this._initialValue,
                    valueIndicator: {
                        color: "#111",
                    },

                    geometry: {
                        startAngle: 180,
                        endAngle: 360,
                    },

                    scale: {
                        startValue: this._higherValue == 220 ? 0 : 32,
                        endValue: this._higherValue,
                        customTicks:
                            this._higherValue == 220
                                ? [0, 37, 73, 110, 147, 183, 220]
                                : [32, 34, 36, 38, 40, 42],

                        tick: {
                            length: 8,
                        },

                        label: {
                            font: {
                                color: "#111",
                                size: 9,
                                family: '"Open Sans", sans-serif',
                            },
                        },
                    },

                    title: {
                        verticalAlignment: "bottom",
                        text: this._title,
                        font: {
                            family: '"Open Sans", sans-serif',
                            color: "#111",
                            size: 10,
                        },

                        subtitle: {
                            text: this._subtitle,
                            font: {
                                family: '"Open Sans", sans-serif',
                                color: "#111",
                                weight: 700,
                                size: 28,
                            },
                        },
                    },

                    onInitialized: function () {
                        let currentGauge = $(element);
                        let circle = currentGauge
                            .find(".dxg-spindle-hole")
                            .clone();
                        let border = currentGauge
                            .find(".dxg-spindle-border")
                            .clone();

                        currentGauge
                            .find(".dxg-title text")
                            .first()
                            .attr("y", 48);
                        currentGauge
                            .find(".dxg-title text")
                            .last()
                            .attr("y", 28);
                        // currentGauge.find('.dxg-value-indicator').append(border, circle);
                    },
                };
            }

            init() {
                $(this._element).dxCircularGauge(this._buildConfig());
            }
        }

        $(document).ready(function () {
            $(".gauge").each(function (index, item) {
                let params = {
                    initialValue: index ? 0 : 0,
                    higherValue: index ? 42 : 220,
                    title: index ? `Body Temperature` : `Heart rate`,
                    subtitle: index ? "0 ºC" : "0 BPM",
                };

                let gauge = new GaugeChart(item, params);
                gauge.init();
            });
        });
        socket2.onmessage = function (e) {
            console.log(e.data);
            document
                .getElementById(JSON.parse(e.data).user)
                .classList.add("online");
            if (!user) {
                user = JSON.parse(e.data).user;
            }
            if (JSON.parse(e.data).user === user) {
                $(".gauge").each(function (index, item) {
                    let gauge = $(item).dxCircularGauge("instance");
                    let randomNum = Math.round(Math.random() * 1560);
                    let gaugeElement = $(gauge._$element[0]);

                    gaugeElement
                        .find(".dxg-title text")
                        .last()
                        .html(
                            `${
                                !index
                                    ? JSON.parse(e.data).heart_rate + `BPM`
                                    : JSON.parse(e.data).temp + `ºC`
                            }`
                        );
                    gauge.value(
                        !index
                            ? JSON.parse(e.data).heart_rate
                            : JSON.parse(e.data).temp
                    );
                });
                L.marker([
                    JSON.parse(e.data).latitude,
                    JSON.parse(e.data).longitude,
                ])
                    .addTo(map)
                    .bindPopup("patient location")
                    .openPopup();
                map.panTo([
                    JSON.parse(e.data).latitude,
                    JSON.parse(e.data).longitude,
                ]);
            } else {
                $(document).ready(function () {
                    $(".gauge").each(function (index, item) {
                        let params = {
                            initialValue: index ? 0 : 0,
                            higherValue: index ? 42 : 220,
                            title: index ? `Body Temperature` : `Heart rate`,
                            subtitle: index ? "0 ºC" : "0 BPM",
                        };

                        let gauge = new GaugeChart(item, params);
                        gauge.init();
                    });
                });
            }
        };
    });
</script>
{% endblock content %}
